<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Arts Team Request Form</title>
    <!-- Use the Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <!-- Include Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-overlay {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            display: flex;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- Main Container -->
    <div class="bg-white rounded-xl shadow-lg w-full max-w-4xl p-8 transform transition-all duration-300 hover:shadow-xl space-y-8">
        <!-- Branding Header -->
        <div class="text-center">
            <div class="flex flex-col items-center justify-center mb-4">
                <img src="https://avatars.planningcenteronline.com/uploads/organization/41987-1346207477/avatar.4.png" alt="Providence City Church Logo" class="w-48 sm:w-64 mb-4 shadow-md rounded-xl">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Creative Arts Team</h1>
            </div>
            <h2 class="text-xl sm:text-2xl font-bold text-gray-700 mb-2">Request Form & Dashboard</h2>
            <p class="text-gray-600">Please fill out this form to request supplies, repairs, or upgrades.</p>
        </div>

        <!-- The main form element -->
        <form id="requestForm" class="space-y-6">

            <!-- Requester Name -->
            <div>
                <label for="requesterName" class="block text-sm font-medium text-gray-700 mb-1">Requester Name</label>
                <input type="text" id="requesterName" name="requesterName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors duration-200">
            </div>

            <!-- Request Date -->
            <div>
                <label for="requestDate" class="block text-sm font-medium text-gray-700 mb-1">Request Date</label>
                <input type="date" id="requestDate" name="requestDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors duration-200">
            </div>

            <!-- Request Type (Main Category) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Request Type</label>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <label class="flex items-center space-x-2 bg-gray-50 p-3 rounded-lg border border-gray-300 cursor-pointer">
                        <input type="radio" name="requestType" value="Supplies" required class="text-emerald-600">
                        <span class="text-gray-700 font-medium">Supplies</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-50 p-3 rounded-lg border border-gray-300 cursor-pointer">
                        <input type="radio" name="requestType" value="Repairs" class="text-emerald-600">
                        <span class="text-gray-700 font-medium">Repairs</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-gray-50 p-3 rounded-lg border border-gray-300 cursor-pointer">
                        <input type="radio" name="requestType" value="Upgrades" class="text-emerald-600">
                        <span class="text-gray-700 font-medium">Upgrades</span>
                    </label>
                </div>
            </div>

            <!-- Sub-category menus (initially hidden) -->
            <div id="subcategories" class="hidden space-y-4">
                <!-- Supplies Sub-category -->
                <div id="suppliesSubcategory" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Supplies Category</label>
                    <div class="space-y-2">
                        <details class="bg-gray-50 p-3 rounded-lg border border-gray-300 cursor-pointer">
                            <summary class="font-medium text-gray-700 flex justify-between items-center">Audio Supplies</summary>
                            <div class="mt-2 space-y-2">
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="supplies_audio[]" value="Cables" data-link="https://www.amazon.com/dp/B002K88E7K" class="rounded text-emerald-600">
                                    <span>Cables</span>
                                </label>
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="supplies_audio[]" value="Batteries" data-link="https://www.amazon.com/dp/B003L4972E" class="rounded text-emerald-600">
                                    <span>Batteries</span>
                                </label>
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="supplies_audio[]" value="Gaff Tape" data-link="https://www.amazon.com/dp/B003I005V8" class="rounded text-emerald-600">
                                    <span>Gaff Tape</span>
                                </label>
                                <div class="flex items-center space-x-2 text-gray-700 flex-wrap">
                                    <label class="flex items-center space-x-2 text-gray-700">
                                        <input type="checkbox" name="supplies_audio_other_checkbox" class="rounded text-emerald-600 custom-option-checkbox">
                                        <span>Other:</span>
                                    </label>
                                    <input type="text" name="supplies_audio_other" placeholder="Specify item" disabled class="flex-grow ml-2 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500">
                                    <input type="url" name="supplies_audio_other_link" placeholder="Paste link here (Optional)" disabled class="flex-grow ml-2 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500">
                                </div>
                            </div>
                        </details>
                        <!-- Other Supplies Categories -->
                        <details class="bg-gray-50 p-3 rounded-lg border border-gray-300 cursor-pointer">
                            <summary class="font-medium text-gray-700 flex justify-between items-center">Video Supplies</summary>
                            <div class="mt-2 space-y-2">
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="supplies_video[]" value="HDMI Cables" data-link="https://www.amazon.com/dp/B08V819G8W" class="rounded text-emerald-600">
                                    <span>HDMI Cables</span>
                                </label>
                                <div class="flex items-center space-x-2 text-gray-700 flex-wrap">
                                    <label class="flex items-center space-x-2 text-gray-700">
                                        <input type="checkbox" name="supplies_video_other_checkbox" class="rounded text-emerald-600 custom-option-checkbox">
                                        <span>Other:</span>
                                    </label>
                                    <input type="text" name="supplies_video_other" placeholder="Specify item" disabled class="flex-grow ml-2 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500">
                                    <input type="url" name="supplies_video_other_link" placeholder="Paste link here (Optional)" disabled class="flex-grow ml-2 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500">
                                </div>
                            </div>
                        </details>
                        <details class="bg-gray-50 p-3 rounded-lg border border-gray-300 cursor-pointer">
                            <summary class="font-medium text-gray-700 flex justify-between items-center">Lighting Supplies</summary>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center space-x-2 text-gray-700 flex-wrap">
                                    <label class="flex items-center space-x-2 text-gray-700">
                                        <input type="checkbox" name="supplies_lighting_other_checkbox" class="rounded text-emerald-600 custom-option-checkbox">
                                        <span>Other:</span>
                                    </label>
                                    <input type="text" name="supplies_lighting_other" placeholder="Specify item" disabled class="flex-grow ml-2 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500">
                                    <input type="url" name="supplies_lighting_other_link" placeholder="Paste link here (Optional)" disabled class="flex-grow ml-2 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500">
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
                <!-- Repairs Sub-category -->
                <div id="repairsSubcategory" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Repairs Category</label>
                    <div class="space-y-2">
                        <details class="bg-gray-50 p-3 rounded-lg border border-gray-300 cursor-pointer">
                            <summary class="font-medium text-gray-700 flex justify-between items-center">Audio Equipment</summary>
                            <div class="mt-2 space-y-2">
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="repairs_audio[]" value="Microphone" class="rounded text-emerald-600">
                                    <span>Microphone</span>
                                </label>
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="repairs_audio[]" value="Speaker" class="rounded text-emerald-600">
                                    <span>Speaker</span>
                                </label>
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="repairs_audio[]" value="Mixer" class="rounded text-emerald-600">
                                    <span>Mixer</span>
                                </label>
                                <div class="flex items-center space-x-2 text-gray-700 flex-wrap">
                                    <label class="flex items-center space-x-2 text-gray-700">
                                        <input type="checkbox" name="repairs_audio_other_checkbox" class="rounded text-emerald-600 custom-option-checkbox">
                                        <span>Other:</span>
                                    </label>
                                    <input type="text" name="repairs_audio_other" placeholder="Specify item" disabled class="flex-grow ml-2 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500">
                                </div>
                            </div>
                        </details>
                        <!-- Other Repairs Categories -->
                        <details class="bg-gray-50 p-3 rounded-lg border border-gray-300 cursor-pointer">
                            <summary class="font-medium text-gray-700 flex justify-between items-center">Video Equipment</summary>
                            <div class="mt-2 space-y-2">
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="repairs_video[]" value="Camera" class="rounded text-emerald-600">
                                    <span>Camera</span>
                                </label>
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="repairs_video[]" value="Projector" class="rounded text-emerald-600">
                                    <span>Projector</span>
                                </label>
                                <div class="flex items-center space-x-2 text-gray-700 flex-wrap">
                                    <label class="flex items-center space-x-2 text-gray-700">
                                        <input type="checkbox" name="repairs_video_other_checkbox" class="rounded text-emerald-600 custom-option-checkbox">
                                        <span>Other:</span>
                                    </label>
                                    <input type="text" name="repairs_video_other" placeholder="Specify item" disabled class="flex-grow ml-2 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500">
                                </div>
                            </div>
                        </details>
                        <details class="bg-gray-50 p-3 rounded-lg border border-gray-300 cursor-pointer">
                            <summary class="font-medium text-gray-700 flex justify-between items-center">Lighting Fixtures</summary>
                            <div class="mt-2 space-y-2">
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="repairs_lighting[]" value="Stage Lights" class="rounded text-emerald-600">
                                    <span>Stage Lights</span>
                                </label>
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="repairs_lighting[]" value="DMX Controller" class="rounded text-emerald-600">
                                    <span>DMX Controller</span>
                                </label>
                                <div class="flex items-center space-x-2 text-gray-700 flex-wrap">
                                    <label class="flex items-center space-x-2 text-gray-700">
                                        <input type="checkbox" name="repairs_lighting_other_checkbox" class="rounded text-emerald-600 custom-option-checkbox">
                                        <span>Other:</span>
                                    </label>
                                    <input type="text" name="repairs_lighting_other" placeholder="Specify item" disabled class="flex-grow ml-2 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500">
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
                <!-- Upgrades Sub-category -->
                <div id="upgradesSubcategory" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Upgrades Category</label>
                    <div class="space-y-2">
                        <details class="bg-gray-50 p-3 rounded-lg border border-gray-300 cursor-pointer">
                            <summary class="font-medium text-gray-700 flex justify-between items-center">Audio System</summary>
                            <div class="mt-2 space-y-2">
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="upgrades_audio[]" value="Wireless Mic System" class="rounded text-emerald-600">
                                    <span>Wireless Mic System</span>
                                </label>
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="upgrades_audio[]" value="Speakers" class="rounded text-emerald-600">
                                    <span>Speakers</span>
                                </label>
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="upgrades_audio[]" value="Mixing Console" class="rounded text-emerald-600">
                                    <span>Mixing Console</span>
                                </label>
                                <div class="flex items-center space-x-2 text-gray-700 flex-wrap">
                                    <label class="flex items-center space-x-2 text-gray-700">
                                        <input type="checkbox" name="upgrades_audio_other_checkbox" class="rounded text-emerald-600 custom-option-checkbox">
                                        <span>Other:</span>
                                    </label>
                                    <input type="text" name="upgrades_audio_other" placeholder="Specify item" disabled class="flex-grow ml-2 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500">
                                </div>
                            </div>
                        </details>
                        <!-- Other Upgrades Categories -->
                        <details class="bg-gray-50 p-3 rounded-lg border border-gray-300 cursor-pointer">
                            <summary class="font-medium text-gray-700 flex justify-between items-center">Video System</summary>
                            <div class="mt-2 space-y-2">
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="upgrades_video[]" value="Projector" class="rounded text-emerald-600">
                                    <span>Projector</span>
                                </label>
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="upgrades_video[]" value="Live Stream Rig" class="rounded text-emerald-600">
                                    <span>Live Stream Rig</span>
                                </label>
                                <div class="flex items-center space-x-2 text-gray-700 flex-wrap">
                                    <label class="flex items-center space-x-2 text-gray-700">
                                        <input type="checkbox" name="upgrades_video_other_checkbox" class="rounded text-emerald-600 custom-option-checkbox">
                                        <span>Other:</span>
                                    </label>
                                    <input type="text" name="upgrades_video_other" placeholder="Specify item" disabled class="flex-grow ml-2 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500">
                                </div>
                            </div>
                        </details>
                        <details class="bg-gray-50 p-3 rounded-lg border border-gray-300 cursor-pointer">
                            <summary class="font-medium text-gray-700 flex justify-between items-center">Lighting System</summary>
                            <div class="mt-2 space-y-2">
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="upgrades_lighting[]" value="Stage Lights" class="rounded text-emerald-600">
                                    <span>Stage Lights</span>
                                </label>
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="checkbox" name="upgrades_lighting[]" value="DMX Controller" class="rounded text-emerald-600">
                                    <span>DMX Controller</span>
                                </label>
                                <div class="flex items-center space-x-2 text-gray-700 flex-wrap">
                                    <label class="flex items-center space-x-2 text-gray-700">
                                        <input type="checkbox" name="upgrades_lighting_other_checkbox" class="rounded text-emerald-600 custom-option-checkbox">
                                        <span>Other:</span>
                                    </label>
                                    <input type="text" name="upgrades_lighting_other" placeholder="Specify item" disabled class="flex-grow ml-2 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500">
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </div>

            <!-- Item(s) Description -->
            <div>
                <label for="itemDescription" class="block text-sm font-medium text-gray-700 mb-1">Item(s) Description</label>
                <textarea id="itemDescription" name="itemDescription" rows="4" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors duration-200"></textarea>
            </div>

            <!-- Urgency -->
            <div>
                <label for="urgency" class="block text-sm font-medium text-gray-700 mb-1">Urgency</label>
                <select id="urgency" name="urgency" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors duration-200">
                    <option value="" disabled selected>Select urgency</option>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                </select>
            </div>

            <!-- Submit Button -->
            <button type="button" id="submitBtn" class="w-full bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-colors duration-200">Submit Request</button>
        </form>

        <!-- Requests Log Section -->
        <div class="mt-8 pt-8 border-t border-gray-300">
            <h3 class="text-2xl font-bold text-gray-700 mb-4">Requests Log</h3>
            <div id="requestsContainer" class="space-y-4">
                <p class="text-gray-500 text-center" id="loadingMessage">Loading requests...</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay fixed inset-0 bg-gray-600 bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Confirm Your Request</h2>
            <div id="summaryContent" class="text-gray-700 mb-6 space-y-2"></div>
            <div class="flex justify-between space-x-4">
                <button id="cancelConfirmBtn" class="flex-1 bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors duration-200">Cancel</button>
                <button id="sendRequestBtn" class="flex-1 bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-700 transition-colors duration-200">Send Request</button>
            </div>
        </div>
    </div>

    <!-- Status Modal -->
    <div id="statusModal" class="modal-overlay fixed inset-0 bg-gray-600 bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-center text-gray-800"></h2>
            <p id="modalMessage" class="text-center text-gray-600 mb-6"></p>
            <div class="flex justify-center">
                <button id="closeModalBtn" class="bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-emerald-700 transition-colors duration-200">Close</button>
            </div>
        </div>
    </div>

    <script>
        // References to UI elements
        const requestsContainer = document.getElementById('requestsContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const confirmModal = document.getElementById('confirmModal');
        const statusModal = document.getElementById('statusModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const summaryContent = document.getElementById('summaryContent');
        const sendRequestBtn = document.getElementById('sendRequestBtn');
        const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
        const requestForm = document.getElementById('requestForm');
        const submitBtn = document.getElementById('submitBtn');

        const LOCAL_STORAGE_KEY = 'creativeArtsRequests';

        // --- Local Storage Functions ---
        function getRequestsFromLocalStorage() {
            try {
                const requests = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || [];
                return requests;
            } catch (e) {
                console.error("Failed to parse requests from local storage", e);
                return [];
            }
        }

        function saveRequestToLocalStorage(request) {
            const requests = getRequestsFromLocalStorage();
            requests.push(request);
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(requests));
                return true;
            } catch (e) {
                console.error("Failed to save request to local storage", e);
                return false;
            }
        }

        // --- UI Rendering ---
        function renderRequests(requests) {
            if (requests.length === 0) {
                loadingMessage.textContent = "No requests found yet.";
                return;
            }

            loadingMessage.classList.add('hidden');
            requestsContainer.innerHTML = '';
            
            // Sort requests by timestamp in descending order
            requests.sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            requests.forEach(req => {
                const requestCard = document.createElement('div');
                requestCard.className = 'bg-gray-50 p-6 rounded-lg shadow-sm border border-gray-200';
                
                const formattedDate = new Date(req.timestamp).toLocaleString();
                
                const subCategoryList = req.subCategory ? JSON.parse(req.subCategory).map(item => `<li>${item.name} (${item.subcategory})</li>`).join('') : '';

                requestCard.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2">
                        <h4 class="text-lg font-bold text-emerald-600">${req.requesterName} - ${req.requestType}</h4>
                        <span class="text-sm text-gray-500">${formattedDate}</span>
                    </div>
                    <div class="text-sm text-gray-700 space-y-1">
                        <p><span class="font-semibold">Urgency:</span> ${req.urgency}</p>
                        ${req.itemDescription ? `<p><span class="font-semibold">Description:</span> ${req.itemDescription}</p>` : ''}
                        ${subCategoryList ? `<p class="mt-4 font-semibold">Selected Items:</p><ul class="list-disc list-inside space-y-1">${subCategoryList}</ul>` : ''}
                    </div>
                `;
                requestsContainer.appendChild(requestCard);
            });
        }
        
        // --- Event Listeners and Form Logic ---
        submitBtn.addEventListener('click', () => {
            if (!requestForm.checkValidity()) {
                requestForm.reportValidity();
                return;
            }

            // Start pre-submission process
            modalTitle.textContent = "Processing Request...";
            modalMessage.textContent = "Please wait while we prepare your submission.";
            statusModal.classList.add('open');
            submitBtn.disabled = true;

            const formData = new FormData(requestForm);
            const data = Object.fromEntries(formData.entries());

            // Collect all selected checkbox values, including custom inputs
            const selectedItems = [];
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    const nameParts = checkbox.name.split('_');
                    const categoryType = nameParts[0] || 'Misc';
                    let subcategory = nameParts[1] || 'General';
                    let itemValue = checkbox.value;
                    let itemLink = checkbox.dataset.link || '';

                    if (checkbox.classList.contains('custom-option-checkbox')) {
                        const customInput = checkbox.closest('.flex').querySelector('input[type="text"]');
                        const customLinkInput = checkbox.closest('.flex').querySelector('input[type="url"]');
                        itemValue = customInput ? customInput.value.trim() : 'N/A';
                        itemLink = customLinkInput ? customLinkInput.value.trim() : '';
                        subcategory = subcategory + " (Custom)";
                    }
                    selectedItems.push({
                        category: categoryType,
                        subcategory: subcategory,
                        name: itemValue,
                        link: itemLink
                    });
                }
            });
            data.subCategory = JSON.stringify(selectedItems);
            data.timestamp = new Date().toISOString();

            // Populate and show the confirmation modal
            statusModal.classList.remove('open');
            summaryContent.innerHTML = `
                <p><span class="font-semibold">Requester:</span> ${data.requesterName}</p>
                <p><span class="font-semibold">Request Type:</span> ${data.requestType}</p>
                <p><span class="font-semibold">Urgency:</span> ${data.urgency}</p>
                ${data.itemDescription ? `<p><span class="font-semibold">Description:</span> ${data.itemDescription}</p>` : ''}
                ${selectedItems.length > 0 ? `<p class="mt-4 font-semibold">Selected Items:</p>
                <ul class="list-disc list-inside space-y-1">${selectedItems.map(item => `<li>${item.name} (${item.subcategory})</li>`).join('')}</ul>` : ''}
            `;
            confirmModal.classList.add('open');

            // Handle confirm and cancel button clicks
            sendRequestBtn.onclick = () => {
                confirmModal.classList.remove('open');
                const success = saveRequestToLocalStorage(data);
                if (success) {
                    modalTitle.textContent = "Request Submitted Successfully!";
                    modalMessage.textContent = "Your request has been saved to the log.";
                    requestForm.reset();
                    renderRequests(getRequestsFromLocalStorage()); // Rerender the log
                } else {
                    modalTitle.textContent = "Submission Failed";
                    modalMessage.textContent = "There was an error submitting your request. Please check the console for details.";
                }
                statusModal.classList.add('open');
                submitBtn.disabled = false;
            };

            cancelConfirmBtn.onclick = () => {
                confirmModal.classList.remove('open');
                submitBtn.disabled = false;
            };
        });
        
        // Hide modals
        closeModalBtn.addEventListener('click', () => {
            statusModal.classList.remove('open');
        });

        // Form logic to show/hide sub-category dropdowns and toggle description required attribute
        const requestTypeRadios = document.querySelectorAll('input[name="requestType"]');
        const suppliesSubcategoryDiv = document.getElementById('suppliesSubcategory');
        const repairsSubcategoryDiv = document.getElementById('repairsSubcategory');
        const upgradesSubcategoryDiv = document.getElementById('upgradesSubcategory');
        const subcategoriesContainer = document.getElementById('subcategories');
        const itemDescription = document.getElementById('itemDescription');

        requestTypeRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                subcategoriesContainer.classList.remove('hidden');
                suppliesSubcategoryDiv.classList.add('hidden');
                repairsSubcategoryDiv.classList.add('hidden');
                upgradesSubcategoryDiv.classList.add('hidden');

                if (event.target.value === 'Supplies') {
                    suppliesSubcategoryDiv.classList.remove('hidden');
                    itemDescription.removeAttribute('required'); // Un-require for Supplies
                } else if (event.target.value === 'Repairs') {
                    repairsSubcategoryDiv.classList.remove('hidden');
                    itemDescription.setAttribute('required', 'required'); // Require for Repairs
                } else if (event.target.value === 'Upgrades') {
                    upgradesSubcategoryDiv.classList.remove('hidden');
                    itemDescription.setAttribute('required', 'required'); // Require for Upgrades
                }
            });
        });

        // Corrected logic for custom text inputs
        document.querySelectorAll('.custom-option-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (event) => {
                const parentFlex = event.target.closest('.flex');
                const customInput = parentFlex.querySelector('input[type="text"]');
                const customLinkInput = parentFlex.querySelector('input[type="url"]');
                if (event.target.checked) {
                    if (customInput) customInput.removeAttribute('disabled');
                    if (customLinkInput) customLinkInput.removeAttribute('disabled');
                    if (customInput) customInput.focus();
                } else {
                    if (customInput) customInput.setAttribute('disabled', 'disabled');
                    if (customLinkInput) customLinkInput.setAttribute('disabled', 'disabled');
                    if (customInput) customInput.value = '';
                    if (customLinkInput) customLinkInput.value = '';
                }
            });
        });
        
        // Handle initial form state and load existing requests
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('requestDate');
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;

            // Load existing requests from local storage on page load
            renderRequests(getRequestsFromLocalStorage());
        });
    </script>
</body>
</html>
